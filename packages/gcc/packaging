set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# $BOSH_COMPILE_TARGET - where this package & spec'd source files are available
# $BOSH_INSTALL_TARGET - where you copy/install files to be included in package
#/sbin/swapoff -a

export HOME=/var/vcap

#cp -a brokers $BOSH_INSTALL_TARGET/brokers
# Retrieving number of cpus on compilation server
  cpun_=`lscpu | grep '^CPU('|tr -d [:space:]|cut -d":" -f2`

# Compiling needed libs

# m4

for i in `find gcc/  -type f -name 'm4-*tar*' -print`
do
  ext_dir=`tar -tvf $i |tail -1| tr -s [:space:] | cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  ./configure --prefix=$BOSH_INSTALL_TARGET
  make && make install
  cd ..
done

# gmp
for i in `find gcc/  -type f -name 'gmp-*tar*' -print`
do
  ext_dir=`tar -tvf $i |tail -1| tr -s [:space:] | cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
   M4=$BOSH_INSTALL_TARGET/bin/m4 ./configure --prefix=$BOSH_INSTALL_TARGET 
  make && make install
  cd ..
done

# mpfr
for i in `find gcc/  -type f -name 'mpfr-*tar*' -print`
do
  ext_dir=`tar -tvf $i |tail -1| tr -s [:space:] | cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  ./configure --prefix=$BOSH_INSTALL_TARGET --with-gmp=$BOSH_INSTALL_TARGET
  make && make install
  cd ..
done


# mpc
for i in `find gcc/  -type f -name 'mpc-*tar*' -print`
do
  ext_dir=`tar -tvf $i |tail -1| tr -s [:space:] | cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  ./configure --prefix=$BOSH_INSTALL_TARGET --with-gmp=$BOSH_INSTALL_TARGET --with-mpfr=$BOSH_INSTALL_TARGET
  make && make install
  cd ..
done

# Filling PATHs
export LD_LIBRARY_PATH=`echo $BOSH_INSTALL_TARGET/lib:${LD_LIBRARY_PATH:-''}|sed -e 's/^://' -e 's/:$//'`
export C_INCLUDE_PATH=`echo $BOSH_INSTALL_TARGET/include:${C_INCLUDE_PATH:-''}|sed -e 's/^://' -e 's/:$//'`
export PATH=`echo $BOSH_INSTALL_TARGET/bin:${PATH:-''}|sed -e 's/^://' -e 's/:$//'`

# Compiling GCC

for i in `find gcc/  -type f -name 'gcc*.tar.gz' -print`
do
  ext_dir=`tar -tvf $i |tail -1| tr -s [:space:] | cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  mkdir build
  cd build
  LDFLAGS="-L$BOSH_INSTALL_TARGET/lib" CPPFLAGS="-I$BOSH_INSTALL_TARGET/include" ../configure -v \
  --prefix=$BOSH_INSTALL_TARGET --enable-shared --enable-linker-build-id --without-included-gettext --enable-threads=posix  \
  --enable-nls --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes \
  --enable-gnu-unique-object --disable-libmudflap --enable-plugin --with-system-zlib --disable-browser-plugin \
  --enable-gtk-cairo --with-arch-directory=amd64 --enable-objc-gc --with-tune=generic \
  --enable-checking=release --build=x86_64-linux-gnu \
  --with-gmp=$BOSH_INSTALL_TARGET --with-mpfr=$BOSH_INSTALL_TARGET \
  --with-mpc=$BOSH_INSTALL_TARGET --disable-multilib

  make -j $cpun_ 
  make install
  cd ../..
done

# libffi needs texinfo (makeinfo) ... bc , compiled in binutils package needs it too
for i in `find gcc/ -type f -name 'texinfo*tar.*' -print`
do
  ext_dir=`tar -tvf $i |tail -1|tr -s [:space:]|cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  mkdir build
  cd build
  LDFLAGS='-L/var/vcap/packages/gcc/lib -L/var/vcap/packages/gcc/lib64' \
  CPPFLAGS="-I/var/vcap/packages/gcc/include" \
  ../configure --prefix=$BOSH_INSTALL_TARGET
  make && make install
  cd ../..
done

# adding automake, autoconf and libtools (needed by libffi) - they have to be  compiled in this order

# autoconf
for i in `find gcc/  -type f -name 'autoconf*.tar.*' -print`
do
  ext_dir=`tar -tvf $i |tail -1| tr -s [:space:] | cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  mkdir build
  cd build
  CC=$BOSH_INSTALL_TARGET/bin/gcc CPPFLAGS=-I$BOSH_INSTALL_TARGET/include LDFLAGS=-L$BOSH_INSTALL_TARGET/lib ../configure --prefix=$BOSH_INSTALL_TARGET 
  make && make install
  cd ../..
done

# automake
for i in `find gcc/  -type f -name 'automake*.tar.*' -print`
do
  ext_dir=`tar -tvf $i |tail -1| tr -s [:space:] | cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  mkdir build
  cd build
  CC=$BOSH_INSTALL_TARGET/bin/gcc CPPFLAGS=-I$BOSH_INSTALL_TARGET/include LDFLAGS=-L$BOSH_INSTALL_TARGET/lib ../configure --prefix=$BOSH_INSTALL_TARGET 
  make && make install
  cd ../..
done  

# libtool
for i in `find gcc/  -type f -name 'libtool*.tar.*' -print`
do
  ext_dir=`tar -tvf $i |tail -1| tr -s [:space:] | cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  mkdir build
  cd build
  CC=$BOSH_INSTALL_TARGET/bin/gcc CPPFLAGS=-I$BOSH_INSTALL_TARGET/include LDFLAGS=-L$BOSH_INSTALL_TARGET/lib ../configure --prefix=$BOSH_INSTALL_TARGET 
  make && make install
  cd ../..
done

for i in `find gcc/  -type f -name 'libpcap*.tar.*' -print`
do
  ext_dir=`tar -tvf $i |tail -1| tr -s [:space:] | cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  mkdir build
  cd build
  ../configure --prefix=$BOSH_INSTALL_TARGET CC=$BOSH_INSTALL_TARGET/bin/gcc CPPFLAGS=-I$BOSH_INSTALL_TARGET/include LDFLAGS=-L$BOSH_INSTALL_TARGET/lib
  make && make install
  cd ../..
done

# adding libffi (needed by python cryptography module)
for i in `find gcc/  -type f -name 'libffi-*.tar.*' -print`
do
  ext_dir=`tar -tvf $i |tail -1| tr -s [:space:] | cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  # running autogen.sh to generate configure file
  ./autogen.sh
  
  # libffi install include in bad directory (under $prefix/lib/.../include) instead of $prefix/include

  perl -pe 's#^AM_CFLAGS = .*#AM_CFLAGS = -g#' -i Makefile.in
  perl -pe 's#^includesdir = .*#includesdir = \@includedir\@#' -i include/Makefile.in

  CC=$BOSH_INSTALL_TARGET/bin/gcc CPPFLAGS=-I$BOSH_INSTALL_TARGET/include LDFLAGS=-L$BOSH_INSTALL_TARGET/lib ./configure --prefix=$BOSH_INSTALL_TARGET 
  make && make install
  cd ..
done
