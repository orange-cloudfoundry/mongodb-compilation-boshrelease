set -e # exit immediately if a simple command exits with a non-zero status
#set -u # report the usage of uninitialized variables

# $BOSH_COMPILE_TARGET - where this package & spec'd source files are available
# $BOSH_INSTALL_TARGET - where you copy/install files to be included in package
#/sbin/swapoff -a

export HOME=/var/vcap

export LD_LIBRARY_PATH=${LD_LIBRARY_PATH:-''} # default to empty
for package_lib_dir in $(find  /var/vcap/packages -follow -maxdepth 2 -mindepth 2 -type d -name 'lib' -o -name 'lib64')
do
  export LD_LIBRARY_PATH=${package_lib_dir}:$LD_LIBRARY_PATH
done

export C_INCLUDE_PATH=${C_INCLUDE_PATH:-''}
for package_inc_dir in $(find  /var/vcap/packages -follow -mindepth 2 -path '*include' -o -path '*include/*' -type d)
do
  export C_INCLUDE_PATH=${package_inc_dir}:$C_INCLUDE_PATH
done

for package_bin_dir in $(find  /var/vcap/packages -follow -mindepth 2 -path '*bin' -type d)
do
  export PATH=${package_bin_dir}:$PATH
done

# processing python virtualenv
mkdir -p /var/vcap/data/tmp/python_venv
virtualenv /var/vcap/data/tmp/python_venv
source /var/vcap/data/tmp/python_venv/bin/activate

# Retrieving number of cpus on compilation server
export cpun_=`lscpu | grep '^CPU('|tr -d [:space:]|cut -d":" -f2`

# processing rocksdb
for i in `find mongodb/ -type f -name 'rocksdb-*.tar.gz' -print`
do

  _cflag=""
  for package_inc_dir in $(find  /var/vcap/packages -follow -mindepth 2 -path '*include' -o -path '*include/*' -type d )
  do
    _cflag="-I${package_inc_dir} ${_cflag}"
  done

  _ldlag=""
  for package_lib_dir in $(find  /var/vcap/packages -follow -maxdepth 2 -mindepth 2 -type d -name 'lib' -o -name 'lib64' )
  do
    _ldlag="-L${package_lib_dir} ${_ldlag}"
  done

  ext_dir=`tar -tvf $i |tail -1|tr -s [:space:]| cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  EXTRA_CFLAGS=-fPIC \
  CFLAGS="${_cflag}" \
  LDFLAGS="${_ldflag} \
           -lsnappy -llz4 -lzstd -lssl -lcrypto" \
  DISABLE_JEMALLOC=1 USE_RTTI=1 EXTRA_CXXFLAGS=-fPIC make -j $cpun_ static_lib
  INSTALL_PATH=$BOSH_INSTALL_TARGET make install
  cd ..
done

# extracting mongorocks
for i in `find mongodb/ -type f -name 'mongo-rocks-*.tar.gz' -print`
do
  mongo_rocks_dir=`tar -tvf $i |tail -1|tr -s [:space:]| cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
done

# extracting  mongodb python dependencies
for i in `find mongodb/ -type f -name 'mongodb-python-deps-*.tar.gz' -print`
do
  mongodb_python_deps_dir=`tar -tvf $i |tail -1|tr -s [:space:]| cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
done


for i in `find mongodb/ -type f -name 'mongodb-src*.tar.gz' -print`
do 
  ext_dir=`tar -tvf $i |tail -1|tr -s [:space:]| cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
# add rocksdb module to mongo
  mkdir -p src/mongo/db/modules/
  ln -sf $(readlink -f ../$mongo_rocks_dir) src/mongo/db/modules/rocks

  # installing python dependencies
  if [ -f buildscripts/requirements.txt ]
  then
    # processing subprocess32 which fall in error with pip
    ls ../${mongodb_python_deps_dir}/subprocess32*.tar.gz 1>/dev/null 2>&1
    if [ $? -eq 0 ]
    then
      mkdir -p /var/vcap/data/tmp/sub32
      find $(readlink -f ../${mongodb_python_deps_dir}) -type f -name 'subprocess32*.tar.gz' -exec sh -c 'tar xf $1 -C /var/vcap/data/tmp/sub32 --strip 1' {} {} \;
      cd /var/vcap/data/tmp/sub32
      ./configure
      python setup.py install
      cd -
    fi

    python -mpip install -r buildscripts/requirements.txt --no-index --find-links $(readlink -f ../${mongodb_python_deps_dir})

  fi

  # compiling mongodb
  _cpppath=""
  for package_inc_dir in $(find  /var/vcap/packages -follow -mindepth 2 -path '*include' -o -path '*include/*' -type d)
  do
    _cpppath="-I${package_inc_dir} ${_cpppath}"
  done
  _libpath=""
  for package_lib_dir in $(find  /var/vcap/packages -follow -maxdepth 2 -mindepth 2 -type d -name 'lib' -o -name 'lib64')
  do
    _libpath="-L${package_lib_dir} ${_libpath}"
  done

  export CPPPATH="${_cpppath}" 
  export LIBPATH="${_libpath}"
  export LDFLAGS="${_libpath} \
           -lsnappy -llz4 -lzstd -lssl -lcrypto"
  export LIBS="lz4 zstd snappy ssl crypto"
  export CPPFLAGS="${_cpppath}"

  # Patching SConstruct to retrieve environment non standard variables
  # Be careful this is python code so do not change indentation or it will affect the 
  sed -i "$(grep -n "\-\-\- other build setup" SConstruct|cut -d":" -f1)ifor key in Split('CC CXX AR RANLIB LD NM CFLAGS CXXFLAGS CCFLAGS LIBPATH'):\n  \
value = os.environ.get(key)\n  if value != None:\n    env[key] = Split(value)\nif os.environ.has_key('CPPFLAGS'):\n  \
env['CCFLAGS'] += SCons.Util.CLVar(os.environ['CPPFLAGS'])\nif os.environ.has_key('LDFLAGS'):\n  \
env['LINKFLAGS'] += SCons.Util.CLVar(os.environ['LDFLAGS'])\n" SConstruct

  #here is the text appended:
  #
  #for key in Split('CC CXX AR RANLIB LD NM CFLAGS CXXFLAGS CCFLAGS LIBPATH'):
  #  value = os.environ.get(key)
  #  if value != None:
  #    env[key] = Split(value)
  #if os.environ.has_key('CPPFLAGS'):
  #  env['CCFLAGS'] += SCons.Util.CLVar(os.environ['CPPFLAGS'])
  #if os.environ.has_key('LDFLAGS'):
  #  env['LINKFLAGS'] += SCons.Util.CLVar(os.environ['LDFLAGS'])

  # retrieve mongodb version from package name
  export _mongo_version=`echo $i|sed -e "s/.*[^[0-9]]*\([0-9][0-9]*\.[0-9][0-9]*\.[0-9][0-9]*\).*/\1/"`

  scons -j $cpun_ --ssl --prefix=$BOSH_INSTALL_TARGET   \
  --disable-warnings-as-errors \
  MONGO_VERSION=$_mongo_version \
  core install

  # striping binaries
  # mongo 3.6 introduce python script install_compass which should not be stripped
  file /var/vcap/packages/mongodb/bin/* \
  | grep -v "Python script" \
  | cut -d":" -f1 \
  | xargs -i strip -sg {}
  cd ..
done

# processing mongo-tools
for i in `find mongodb/ -type f -name 'mongo-tools-*.tar.gz' -print`
do
  ext_dir=`tar -tvf $i |tail -1|tr -s [:space:]| cut -d" " -f6 |cut -d"/" -f1`
  tar xf $i
  cd $ext_dir
  
  go_compile_env=$(find /var/vcap/packages/golang-*-linux/bosh -name 'compile.env')

  [ "$go_compile_env" == "" ] && echo "Go compilation environment not found" && exit 1
  source $go_compile_env
  # need libpcap for mongoreplay !!
  export CGO_LDFLAGS="-L/var/vcap/packages/extra/lib -L/var/vcap/packages/extra/lib64"

  # initializing PKG_CONFIG_PATH
  if [ -f /usr/lib/x86_64-linux-gnu/pkgconfig/openssl.pc ] 
  then
    export PKG_CONFIG_PATH="/usr/lib/x86_64-linux-gnu/pkgconfig"
  fi  
  #export PKG_CONFIG_PATH="/var/vcap/packages/git/lib/pkgconfig:$PKG_CONFIG_PATH"
  ./set_gopath.sh
 
  # patching shebang which have to be set to #!/bin/bash 
  sed -ie "1s/^#\!.*$/#\!\/bin\/bash/" build.sh
  ./build.sh ssl
  [ ! -d $BOSH_INSTALL_TARGET/bin ] && mkdir -p $BOSH_INSTALL_TARGET/bin
  cp -rp bin/* $BOSH_INSTALL_TARGET/bin
  cd ..
done
